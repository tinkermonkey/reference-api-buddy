# Config Debug Requirements

## Overview

Create administrative endpoints to expose the current configuration and system state to allow for debugging of problems and monitoring of the proxy's operational status.

## 4.1 Core Configuration Debug Endpoint

### 4.1.1 Configuration Endpoint

**Endpoint**: `GET /admin/config`

**Purpose**: Return the current runtime configuration for debugging purposes

**Security**:
- If security is enabled (`security.require_secure_key = true`), the endpoint must be accessed as `GET /admin/{secure_key}/config`
- If security is disabled, the endpoint is accessible as `GET /admin/config`
- Invalid or missing secure key should return 403 Forbidden

**Response Format**:
```json
{
  "timestamp": "2025-09-16T14:30:00.000Z",
  "proxy_version": "1.0.0",
  "security_enabled": true,
  "configuration": {
    "server": {
      "host": "127.0.0.1",
      "request_timeout": 30
    },
    "security": {
      "require_secure_key": true,
      "log_security_events": true
    },
    "cache": {
      "database_path": ":memory:",
      "max_cache_response_size": 10485760,
      "default_ttl_seconds": 86400
    },
    "throttling": {
      "default_requests_per_hour": 1000,
      "progressive_max_delay": 300
    },
    "logging": {
      "level": "INFO",
      "enable_console": true,
      "enable_file": false
    },
    "domain_mappings": {
      "example": {
        "upstream": "https://api.example.com",
        "ttl_seconds": 3600
      }
    }
  }
}
```

**Security Considerations**:
- The secure key itself must NEVER be included in the response
- Sensitive configuration values (API keys, secrets) should be masked or excluded
- Log the access attempt for security auditing

### 4.1.2 Sanitized Configuration Response

**Data Sanitization Requirements**:
- Replace any field containing "key", "secret", "password", "token" with `"[REDACTED]"`
- Preserve structure but hide sensitive values
- Include a `"sanitized_fields"` array listing what was redacted

**Example with sensitive data**:
```json
{
  "configuration": {
    "external_api": {
      "api_key": "[REDACTED]",
      "secret_token": "[REDACTED]",
      "base_url": "https://api.example.com"
    }
  },
  "sanitized_fields": ["external_api.api_key", "external_api.secret_token"]
}
```

## 4.2 System Status Endpoint

### 4.2.1 Health and Status Endpoint

**Endpoint**: `GET /admin/status`

**Purpose**: Provide comprehensive system health and operational status

**Security**: Same security model as config endpoint

**Response Format**:
```json
{
  "timestamp": "2025-09-16T14:30:00.000Z",
  "status": "healthy",
  "uptime_seconds": 3600,
  "components": {
    "cache_engine": {
      "status": "healthy",
      "backend": "sqlite",
      "total_entries": 150,
      "database_size_bytes": 2048576
    },
    "database_manager": {
      "status": "healthy",
      "connection_active": true,
      "last_backup": "2025-09-16T12:00:00.000Z"
    },
    "throttle_manager": {
      "status": "healthy",
      "active_throttles": 2
    },
    "security_manager": {
      "status": "healthy",
      "security_enabled": true
    }
  },
  "metrics": {
    "total_requests": 1250,
    "cache_hit_rate": 0.85,
    "average_response_time_ms": 150,
    "errors_last_hour": 3
  }
}
```

**Status Values**:
- `"healthy"`: Component is operating normally
- `"degraded"`: Component has minor issues but is functional
- `"error"`: Component has serious issues affecting functionality
- `"unavailable"`: Component is not responding or disabled

## 4.3 Configuration Validation Endpoint

### 4.3.1 Config Validation Endpoint

**Endpoint**: `POST /admin/validate-config`

**Purpose**: Validate a configuration without applying it

**Security**: Same security model as other admin endpoints

**Request Body**:
```json
{
  "configuration": {
    "server": {"host": "127.0.0.1"},
    "cache": {"default_ttl_seconds": -1}
  }
}
```

**Response Format**:
```json
{
  "valid": false,
  "errors": [
    "cache.default_ttl_seconds must be a positive integer"
  ],
  "warnings": [
    "server.request_timeout not specified, using default value of 30"
  ],
  "merged_config": {
    "server": {
      "host": "127.0.0.1",
      "request_timeout": 30
    },
    "cache": {
      "default_ttl_seconds": 86400
    }
  }
}
```

## 4.4 Domain Mapping Debug Endpoint

### 4.4.1 Domain Mappings Endpoint

**Endpoint**: `GET /admin/domains`

**Purpose**: Show all configured domain mappings and their status

**Response Format**:
```json
{
  "timestamp": "2025-09-16T14:30:00.000Z",
  "domain_mappings": {
    "example": {
      "upstream": "https://api.example.com",
      "ttl_seconds": 3600,
      "status": "healthy",
      "last_successful_request": "2025-09-16T14:25:00.000Z",
      "total_requests": 45,
      "cache_entries": 12,
      "error_rate": 0.02
    },
    "test": {
      "upstream": "https://api.test.com",
      "ttl_seconds": 7200,
      "status": "error",
      "last_successful_request": "2025-09-16T12:00:00.000Z",
      "total_requests": 8,
      "cache_entries": 0,
      "error_rate": 0.75,
      "last_error": "Connection timeout"
    }
  }
}
```

## 4.5 Cache Debug Endpoint

### 4.5.1 Cache Overview Endpoint

**Endpoint**: `GET /admin/cache`

**Purpose**: Provide detailed cache statistics and health information

**Response Format**:
```json
{
  "timestamp": "2025-09-16T14:30:00.000Z",
  "cache_backend": "sqlite",
  "database_path": "/path/to/cache.db",
  "total_entries": 150,
  "expired_entries": 5,
  "database_size_bytes": 2048576,
  "statistics": {
    "hit_rate": 0.85,
    "total_hits": 1020,
    "total_misses": 180,
    "total_sets": 200,
    "compressed_entries": 75,
    "average_entry_size_bytes": 13657
  },
  "ttl_distribution": {
    "default_ttl": 120,
    "custom_ttl": 30
  },
  "oldest_entry": "2025-09-09T14:30:00.000Z",
  "newest_entry": "2025-09-16T14:29:45.000Z"
}
```

### 4.5.2 Cache by Domain Endpoint

**Endpoint**: `GET /admin/cache/{domain}`

**Purpose**: Show cache entries and statistics for a specific domain

**Response Format**:
```json
{
  "domain": "example",
  "cache_entries": 12,
  "total_size_bytes": 156800,
  "hit_rate": 0.92,
  "entries": [
    {
      "cache_key": "abc123...",
      "url": "https://api.example.com/users/123",
      "method": "GET",
      "created": "2025-09-16T14:00:00.000Z",
      "expires": "2025-09-16T15:00:00.000Z",
      "size_bytes": 1024,
      "compressed": true,
      "hit_count": 5
    }
  ]
}
```

## 4.6 Implementation Requirements

### 4.6.1 Handler Integration

**Integration Point**: Extend the existing `_handle_request` method in `ProxyHTTPRequestHandler`

**Admin Route Detection**:
```python
# After security validation, check for admin routes
if self.path.startswith("/admin/"):
    self._handle_admin_request(method)
    return
```

### 4.6.2 Admin Request Handler

**New Method**: `_handle_admin_request(self, method: str)`

**Responsibilities**:
1. Parse admin endpoint and parameters
2. Validate security requirements for admin access
3. Route to appropriate admin handler method
4. Return properly formatted JSON responses
5. Log admin access for security auditing

**Supported Endpoints**:
- `GET /admin/config` → `_handle_admin_config()`
- `GET /admin/status` → `_handle_admin_status()`
- `POST /admin/validate-config` → `_handle_admin_validate_config()`
- `GET /admin/domains` → `_handle_admin_domains()`
- `GET /admin/cache` → `_handle_admin_cache()`
- `GET /admin/cache/{domain}` → `_handle_admin_cache_domain(domain)`

### 4.6.3 Response Format Standards

**Standard Response Structure**:
```python
{
    "timestamp": "ISO-8601 timestamp",
    "success": true,
    "data": { ... },
    "errors": [ ... ],  # Only present if errors occurred
    "warnings": [ ... ]  # Only present if warnings exist
}
```

**Error Response Format**:
```python
{
    "timestamp": "ISO-8601 timestamp",
    "success": false,
    "error": "Error message",
    "error_code": "INVALID_CONFIG",
    "details": { ... }  # Optional additional error context
}
```

### 4.6.4 Security and Logging

**Access Logging**:
- Log all admin endpoint access attempts
- Include IP address, timestamp, endpoint, and success/failure
- Never log secure keys or sensitive data

**Rate Limiting**:
- Implement basic rate limiting for admin endpoints (configurable)
- Default: 10 requests per minute per IP address
- Return 429 Too Many Requests when exceeded

**Content-Type Handling**:
- All admin endpoints return `application/json`
- POST endpoints accept `application/json` request bodies
- Return proper HTTP status codes (200, 400, 403, 404, 429, 500)

## 4.7 Configuration Integration

### 4.7.1 Admin Configuration Section

**New Configuration Section**:
```python
"admin": {
    "enabled": true,
    "rate_limit_per_minute": 10,
    "include_sensitive_config": false,
    "log_access": true
}
```

### 4.7.2 Security Integration

**Admin endpoints must respect existing security configuration**:
- When `security.require_secure_key = true`, all admin endpoints require the secure key
- Admin access attempts should be logged according to `security.log_security_events`
- Failed authentication should increment security metrics

## 4.8 Testing Requirements

### 4.8.1 Unit Tests

**Test Coverage Required**:
- Configuration sanitization (removing sensitive data)
- Admin endpoint routing and security validation
- JSON response formatting and structure
- Error handling and proper HTTP status codes
- Rate limiting functionality

### 4.8.2 Integration Tests

**Integration Test Scenarios**:
- Admin endpoints with security enabled/disabled
- Configuration validation with various invalid inputs
- Cache and domain statistics accuracy
- End-to-end admin workflow testing

### 4.8.3 Security Tests

**Security Test Cases**:
- Admin access without secure key (should fail)
- Admin access with invalid secure key (should fail)
- Verify sensitive data is not exposed in responses
- Rate limiting enforcement
- Admin access logging verification
